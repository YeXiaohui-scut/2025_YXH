# 开始使用 / Getting Started

## 5分钟快速上手 / 5-Minute Quick Start

### 第一步: 测试系统 / Step 1: Test the System

```bash
# 测试语义编码 (无需任何数据)
python examples/train_semantic_example.py --mode test_encoding

# 预期输出:
# ✓ Encoder initialized (dim=512)
# ✓ Encryption test passed
```

### 第二步: 查看提示词生成 / Step 2: View Prompt Generation

```bash
# 查看系统生成的提示词多样性
python examples/train_semantic_example.py --mode demo_prompts

# 将看到 100+ 种自动生成的提示词，如:
# - "A photo with natural lighting"
# - "A detailed scene at sunset"
# - "A landscape with vivid colors"
```

### 第三步: 快速训练演示 / Step 3: Quick Training Demo

```bash
# 使用样例数据快速演示训练流程 (2 epochs, 几分钟完成)
python examples/train_semantic_example.py \
    --mode train \
    --use_sample_data \
    --max_epochs 2 \
    --batch_size 4

# 这会:
# - 自动创建 20 张样例图片
# - 生成提示词
# - 训练 2 个 epoch
# - 保存检查点
```

### 第四步: 正式训练 / Step 4: Real Training

准备你的数据:
```
/data/
  └── images/
      ├── image_001.jpg
      ├── image_002.jpg
      └── ...
```

创建图片列表:
```csv
# data/train.csv
path
image_001.jpg
image_002.jpg
...
```

开始训练:
```bash
python train.py \
    --config configs/SD14_SemanticLaWa.yaml \
    --batch_size 8 \
    --max_epochs 40 \
    --learning_rate 0.00006 \
    --output results/my_training
```

**无需图片说明！** 系统会自动生成提示词。

## 如果你有图片说明 / If You Have Captions

### 准备说明文件 / Prepare Caption File

```csv
# data/captions.csv
path,caption
image_001.jpg,一张美丽的风景照
image_002.jpg,一只可爱的猫咪
...
```

### 更新配置 / Update Config

编辑 `configs/SD14_SemanticLaWa.yaml`:

```yaml
data:
  params:
    train:
      params:
        caption_file: data/captions.csv  # 添加这一行
```

### 开始训练 / Start Training

```bash
python train.py --config configs/SD14_SemanticLaWa.yaml
```

## 训练监控 / Training Monitoring

训练过程中关注这些指标:

```
train/cosine_sim    应该逐渐提升到 >0.85
train/psnr          应该保持 >40 dB
train/emb_loss      应该逐渐下降
```

**进度参考:**
- Epochs 1-10: cosine_sim 从 0.3 升到 0.6
- Epochs 10-20: cosine_sim 从 0.6 升到 0.8
- Epochs 20-30: cosine_sim 达到 >0.85 (收敛)

## 训练后使用 / After Training

### 加载模型 / Load Model

```python
from models.semanticLaWa import SemanticLaWa

model = SemanticLaWa.load_from_checkpoint(
    'results/my_training/checkpoints/last.ckpt'
)
```

### 生成带水印图像 / Generate Watermarked Image

```python
# 用特定提示词
prompt = "餐桌上的一盘美食"

# 编码提示词
semantic_vector = model.semantic_encoder(prompt, encrypt=True)

# 生成带水印图像
watermarked = model(latent, original_image, semantic_vector)
```

### 验证水印 / Verify Watermark

```python
# 提取水印
extracted = model.decoder(watermarked)
decrypted = model.semantic_encoder.rotation_matrix.decrypt(extracted)

# 验证
is_authentic, similarity = model.semantic_encoder.verify(
    decrypted, 
    prompt,
    threshold=0.85
)

print(f"真实性: {is_authentic}, 相似度: {similarity:.4f}")
```

## 常见使用场景 / Common Use Cases

### 场景 1: 没有图片说明 (最简单)

```bash
# 直接训练，系统自动生成提示词
python train.py --config configs/SD14_SemanticLaWa.yaml

# 每张图片获得随机但一致的提示词
# 水印仍然是唯一的
```

### 场景 2: 有图片说明

```bash
# 准备 captions.csv
# 更新配置添加 caption_file
# 训练

# 每张图片使用其真实说明
# 水印与内容语义强绑定
```

### 场景 3: T2I 生成

```python
# 使用 Stable Diffusion 生成图像时
prompt = "A beautiful sunset over the ocean"

# 用相同提示词生成语义水印
semantic_vec = encoder(prompt, encrypt=True)
watermarked = model(sd_latent, sd_image, semantic_vec)

# 水印自然与生成内容关联
```

### 场景 4: 批量水印

```python
# 为不同图片使用不同提示词
prompts = [
    "Photo 1 description",
    "Photo 2 description",
    "Photo 3 description"
]

for img, prompt in zip(images, prompts):
    semantic_vec = encoder(prompt, encrypt=True)
    watermarked = model(encode(img), img, semantic_vec)
    save(watermarked)
```

## 故障排查 / Troubleshooting

### 问题: 余弦相似度很低 (<0.70)

**解决方案:**
```yaml
# 增加语义损失权重
semantic_loss_weight: 3.0  # 从 2.0 增加

# 或降低学习率
learning_rate: 0.00004  # 从 0.00006 降低

# 或训练更久
--max_epochs 50
```

### 问题: 水印太明显

**解决方案:**
```yaml
# 降低水印强度
watermark_addition_weight: 0.05  # 从 0.1 降低

# 增加重建损失权重
recon_loss_weight: 0.2  # 从 0.1 增加
```

### 问题: 显存不足

**解决方案:**
```yaml
# 使用轻量级 U-Net
use_lightweight_wemb: True

# 或减小批量大小
--batch_size 4

# 或减小图像尺寸
resize: 256
```

### 问题: CLIP 模型加载失败

**不是问题！** 系统会自动使用哈希后备模式:
```
Warning: transformers not installed. Using fallback encoding mode.
```

这是正常的，训练仍然可以进行。如果想使用 CLIP:
```bash
pip install transformers protobuf
```

## 文档索引 / Documentation Index

### 基础入门 / Getting Started
- **[开始使用.md](开始使用.md)** - 本文档 (5分钟快速上手)
- **[训练指南_中文.md](训练指南_中文.md)** - 完整中文指南

### 技术文档 / Technical Docs
- **[TRAINING_GUIDE.md](TRAINING_GUIDE.md)** - 完整训练指南 (英文)
- **[QUICK_REFERENCE.md](QUICK_REFERENCE.md)** - 快速参考 (流程图)
- **[SEMANTIC_WATERMARKING.md](SEMANTIC_WATERMARKING.md)** - 架构文档

### 示例和演示 / Examples
- **[examples/README_TRAINING.md](examples/README_TRAINING.md)** - 训练示例
- **[examples/train_semantic_example.py](examples/train_semantic_example.py)** - 演示脚本

### 迁移和参考 / Migration & Reference
- **[MIGRATION_GUIDE.md](MIGRATION_GUIDE.md)** - 从二进制迁移
- **[IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md)** - 实现总结

## 推荐学习路径 / Recommended Learning Path

### 路径 1: 快速实践者 (1小时)
1. 阅读本文档 (5分钟)
2. 运行测试和演示 (15分钟)
   ```bash
   python examples/train_semantic_example.py --mode test_encoding
   python examples/train_semantic_example.py --mode demo_prompts
   python examples/train_semantic_example.py --mode train --use_sample_data
   ```
3. 准备数据并开始训练 (30分钟设置 + 训练)

### 路径 2: 深入理解者 (3小时)
1. 阅读本文档 (5分钟)
2. 阅读 [训练指南_中文.md](训练指南_中文.md) (30分钟)
3. 查看 [QUICK_REFERENCE.md](QUICK_REFERENCE.md) 流程图 (15分钟)
4. 运行所有示例和测试 (30分钟)
5. 深入阅读 [SEMANTIC_WATERMARKING.md](SEMANTIC_WATERMARKING.md) (1小时)
6. 开始训练并调整参数 (30分钟)

### 路径 3: 从二进制迁移 (2小时)
1. 阅读 [MIGRATION_GUIDE.md](MIGRATION_GUIDE.md) (45分钟)
2. 更新配置文件 (15分钟)
3. 修改数据加载代码 (30分钟)
4. 测试和验证 (30分钟)

## 支持和帮助 / Support

### 遇到问题?

1. **查看故障排查部分** (本文档上方)
2. **阅读训练指南的常见问题** [训练指南_中文.md](训练指南_中文.md)
3. **查看快速参考的故障排查** [QUICK_REFERENCE.md](QUICK_REFERENCE.md)

### 需要帮助?

在 GitHub 上提交 issue，包括:
- 错误信息
- 配置文件
- 训练命令
- 系统环境

## 下一步 / Next Steps

完成快速上手后:

1. ✅ 运行完整训练 (40 epochs, ~30小时)
2. ✅ 监控训练指标
3. ✅ 测试水印鲁棒性
4. ✅ 集成到你的 T2I 管道
5. ✅ 添加元数据 (模型版本、用户ID等)

## 总结 / Summary

**最简单的开始方式:**

```bash
# 1. 测试 (1分钟)
python examples/train_semantic_example.py --mode test_encoding

# 2. 准备数据 (创建 train.csv)
# 3. 训练 (无需说明文件)
python train.py --config configs/SD14_SemanticLaWa.yaml
```

**就这么简单！系统会自动处理提示词生成和文本融合。**

每张图片将获得基于其提示词的独特、内容相关的语义水印。

---

**准备好了吗？从第一步开始吧！** 🚀
